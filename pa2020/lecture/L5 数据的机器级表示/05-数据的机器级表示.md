## æœ¬è®²æ¦‚è¿°

>[! Question] æˆ‘ä»¬å·²ç»çŸ¥é“æ•°æ®æ˜¯å¦‚ä½•åœ¨è®¡ç®—æœºä¸­è¡¨ç¤ºçš„ã€‚ä½†<font color=" #ff0000 ">ä¸ºä»€ä¹ˆè¦è¿™æ ·è¡¨ç¤º</font>ï¼Ÿè¿™æ ·çš„è¡¨ç¤º<font color=" #ff0000 ">æœ‰ä»€ä¹ˆå¥½å¤„å’Œç”¨æ³•</font>ï¼Ÿ

-   ä½è¿ç®—ä¸å•æŒ‡ä»¤å¤šæ•°æ®
-   æ•´æ•°æº¢å‡ºä¸ Undefined Behavior
-   IEEE754 æµ®ç‚¹æ•°

>[!note] æˆ‘ä»¬ä¹Ÿè®¸æœ‰å¾ˆå¤šè¡¨ç¤ºæ–¹æ³•ï¼Œä½†ä¸ºä»€ä¹ˆç°åœ¨çš„æ ‡å‡†æ˜¯å¥½çš„

# ä¸€ã€ä½è¿ç®—ä¸å•æŒ‡ä»¤å¤šæ•°æ®


## 1.1 ä¸ºä»€ä¹ˆä¼šæœ‰ä½è¿ç®—ï¼Ÿ

é€»è¾‘é—¨å’Œå¯¼çº¿æ˜¯æ„æˆè®¡ç®—æœº (ç»„åˆé€»è¾‘ç”µè·¯) çš„åŸºæœ¬å•å…ƒ

-   ä½è¿ç®—æ˜¯ç”¨ç”µè·¯**æœ€å®¹æ˜“å®ç°**çš„è¿ç®—
    -   `&`Â (ä¸),Â `|`Â (æˆ–),Â `~`Â (é)
    -   `^`Â (å¼‚æˆ–)
    -   `<<`Â (å·¦ç§»ä½),Â `>>`Â (å³ç§»ä½)
    -   ä¾‹å­ï¼šä¸€ä»£ä¼ å¥‡å¤„ç†å™¨ 8-bitÂ [MOS 6502](https://www.masswerk.at/6502/6502_instruction_set.html)
        -   3510 æ™¶ä½“ç®¡ï¼›56 æ¡æŒ‡ä»¤ï¼Œç®—æ•°æŒ‡ä»¤ä»…æœ‰åŠ å‡æ³•å’Œä½è¿ç®—
-   æ•°å­¦ä¸Šè‡ªç„¶çš„æ•´æ•°éœ€è¦å®ç°æˆå›ºå®šé•¿åº¦çš„ 01 å­—ç¬¦ä¸²

>[!answer] ä¹ é¢˜ï¼šç”¨ä¸Šè¿°ä½è¿ç®—å’Œå¸¸æ•°å®ç° 4 ä½æ•´æ•°çš„åŠ æ³•è¿ç®—/Lab1
>-   åŠ æ³•æ¯”ä¸Šè¿°è¿ç®—åœ¨ç”µè·¯ä¸Šå®ç° fundamentally æ›´å›°éš¾ (ä¸ºä»€ä¹ˆï¼Ÿ)
>	-   â€œCircuit Complexityâ€


## 1.2 æ•´æ•°ï¼šå›ºå®šé•¿åº¦çš„ Bit String

`142857 -> 0000 0000 0000 0010 0010 1110 0000 1001`

-   å‡è®¾ 32-bit æ•´æ•°ï¼›çº¦å®š MSB åœ¨å·¦ï¼ŒLSB åœ¨å³

>[! Answer]  çƒ­èº«é—®é¢˜ï¼šå­—ç¬¦ä¸²æ“ä½œ
>
>-   åˆ†åˆ«å–å‡º 4 ä¸ªå­—èŠ‚
>-   äº¤æ¢é«˜/ä½ 16 ä½


## 1.3 å•æŒ‡ä»¤å¤šæ•°æ®

> `&`,Â `|`,Â `~`, ... å¯¹äºæ•´æ•°é‡Œçš„æ¯ä¸€ä¸ª bit æ¥è¯´æ˜¯<font color=" #ff0000 ">ç‹¬ç«‹</font>Â (å¹¶è¡Œ) çš„

å¦‚æœæˆ‘ä»¬æ“ä½œçš„å¯¹è±¡åˆšå¥½æ¯ä¸€ä¸ª bit æ˜¯ç‹¬ç«‹çš„

-   æˆ‘ä»¬åœ¨ä¸€æ¡æŒ‡ä»¤é‡Œå°±å®ç°äº†å¤šä¸ªæ“ä½œ
-   SIMD (Single Instruction, Multiple Data)

>[!example] ä¾‹å­ï¼šBit Set
>-   32-bit æ•´æ•°Â $x \rightarrow S \subseteq\{0,1,2, \ldots, 31\}$
>-   ä½è¿ç®—æ˜¯å¯¹æ‰€æœ‰ bitÂ <font color="#ff0000">åŒæ—¶</font>å®Œæˆçš„
>	-   C++ ä¸­æœ‰Â `bitset`ï¼Œæ€§èƒ½éå¸¸å¯è§‚


## 1.4 Bit Set: åŸºæœ¬æ“ä½œ

æµ‹è¯• $x \in S$
- $(S>x) \& 1$

æ±‚ $S^{\prime}=S \cup \{x\}$
- $S \mid(1<<x)$

æ›´å¤šä¹ é¢˜
- æ±‚ $|S|$
- æ±‚ $S_1 \cup S_2, S_1 \cap S_2$
- æ±‚ $S_1 \backslash S_2$
- éå† $S$ ä¸­çš„æ‰€æœ‰å…ƒç´  (foreach)

>[!note] è€ƒè™‘ä½¿ç”¨çœŸå€¼è¡¨å¹¶è¿›è¡ŒåŒ–ç®€

## 1.5 Bit Set: æ±‚Â $|S|$


```c
int bitset_size(uint32_t S) {
  int n;
  for (int i = 0; i < 32; i++) {
    n += bitset_contains(S, i);
  }
  return n;
}
```

```c
int bitset_size1(uint32_t S) { // SIMD
  S = (S & 0x55555555) + ((S >> 1) & 0x55555555);
  S = (S & 0x33333333) + ((S >> 2) & 0x33333333);
  S = (S & 0x0F0F0F0F) + ((S >> 4) & 0x0F0F0F0F);
  S = (S & 0x00FF00FF) + ((S >> 8) & 0x00FF00FF);
  S = (S & 0x0000FFFF) + ((S >> 16) & 0x0000FFFF);
  return S;
}
```

>[!note] 
>[è§†é¢‘é“¾æ¥ ğŸ”—]( https://www.bilibili.com/video/BV1qa4y1j7xk/?p=5&share_source=copy_web&vd_source=587965785c97101d90acb761204e6795&t=2113 )
>
>>[!quote] [ç®—æ³•-æ±‚äºŒè¿›åˆ¶æ•°ä¸­1çš„ä¸ªæ•° - ç¿°å¢¨å°ç”Ÿ - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/graphics/archive/2010/06/21/1752421.html)
>
>![[è®¡ç®—bitä¸²ä¸­1çš„ä¸ªæ•°.pdf]]

>[!danger] ç°ä»£ç¼–è¯‘å™¨ä¸‹çš„æœ€ä¼˜è§£
>å¯¹äºç°ä»£ç¼–è¯‘å™¨ç‰¹åˆ«æ˜¯ä¸€äº›åµŒå…¥å¼è®¾å¤‡ï¼Œæœ€å¥½çš„æ–¹å¼çš„æ˜¯æŸ¥è¡¨æ³•

## â­ï¸1.6 Bit Set: è¿”å› $S â‰  âˆ…$ ä¸­çš„æŸä¸ªå…ƒç´  (lowbit)

>[!danger] æ³¨æ„ç€é‡è€ƒè™‘æ€ä¹ˆåˆ†æè¿™ä¸ªåˆ†æï¼Ÿ

æœ‰äºŒè¿›åˆ¶æ•° `x = 0b+++++100`ï¼Œæˆ‘ä»¬å¸Œæœ›å¾—åˆ°æœ€åé‚£ä¸ª `100`
-   æƒ³æ³•ï¼šä½¿ç”¨åŸºæœ¬æ“ä½œæ„é€ ä¸€äº›ç»“æœï¼Œèƒ½æŠŠ `+++++` çš„éƒ¨åˆ†ç»™æŠµæ¶ˆæ‰

| è¡¨è¾¾å¼ | ç»“æœ       |
| ------ | ---------- |
| `x`      | `0b+++++100` |
| `x-1`    | `0b+++++011` |
| `~x`     | `0b-----011` |
| `~x+1`  | `0b-----100` |

ä¸€äº›æœ‰è¶£çš„å¼å­ï¼š

-   `x & (x-1)`Â â†’Â `0b+++++000`ï¼›`x ^ (x-1)`Â â†’Â `0b00000111`
-   `x & (~x+1)`Â â†’Â `0b00000100`Â ($lowbitï¸$)
    -   `x & -x`,Â `(~x & (x-1)) + 1`Â éƒ½å¯ä»¥å®ç° $lowbit$
    -   åªéå†å­˜åœ¨çš„å…ƒç´ å¯ä»¥åŠ é€Ÿæ±‚Â $|S|$

## 1.7 Bit Set: æ±‚Â $\lfloor \log_2 (x) \rfloor$

>[!note] å¾—åˆ°äº† $lowbit$ åï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ‰¾åˆ°å…¶å¯¹åº”çš„é›†åˆå…ƒç´ 
>å¾ªç¯éå†æ˜¯ä¸€ç§æ–¹æ³•ï¼Œå®é™…ä¸Šå°±æ˜¯å¯¹ç±»ä¼¼äº $0x00001000$ çš„æ•°å– $log_2$

ç­‰åŒäºÂ $31 - \mathrm{clz}(x)$

```c
int clz(uint32_t x) {
    int n = 0;
    if (x <= 0x0000ffff) n += 16, x <<= 16;
    if (x <= 0x00ffffff) n +=  8, x <<= 8;
    if (x <= 0x0fffffff) n +=  4, x <<= 4;
    if (x <= 0x3fffffff) n +=  2, x <<= 2;
    if (x <= 0x7fffffff) n ++;
    return n;
}
```

(å¥‡æ€ªçš„ä»£ç ) å‡è®¾Â $x$Â æ˜¯Â `lowbit`Â å¾—åˆ°çš„ç»“æœï¼Ÿ

```c
#define LOG2(x) \ 
	("-01J2GK-3@HNL;-=47A-IFO?M:<6-E>95D8CB"[(x) % 37] - '0')
```

ç”¨ä¸€ç‚¹ç‚¹å…ƒç¼–ç¨‹ (meta-programming)ï¼›è¯•ä¸€è¯•Â log2. c å’Œ [[log.py]]
```c
#include <stdio.h>
#include <stdint.h>
#include "log2.inc"

int main() {
  for (int i = 0; i < 64; i++) {
    uint64_t x = 1ULL << i;
    printf("%016llx %d", x, LOG2(x));
  }
}
```

```python
import json

n, base = 64, '0'
for m in range(n, 10000):
  if len({ (2**i) % m for i in range(n) }) == n:
    M = { j: chr(ord(base) + i)
      for j in range(0, m)
        for i in range(0, n)
          if (2**i) % m == j }
    break

magic = json.dumps(''.join(
  [ M.get(j, '-') for j in range(0, m) ]
  )).strip('"')

print(f'#define LOG2(x) ("{magic}"[(x) % {m}] - \'{base}\')')
```

## 1.8  ä¸€æœ¬æœ‰è¶£çš„å‚è€ƒä¹¦

> Henry S. Warren, Jr.Â _Hacker's Delight_Â (2ed), Addison-Wesley, 2012.

è®©ä½ ç†è§£å†™å‡ºæ›´å¿«çš„ä»£ç å¹¶ä¸æ˜¯ â€œççŒœâ€

![[Hacker Delight.png|150]]

-   ä¸»è¦å†…å®¹æ˜¯å„ç§æ•°å­¦ (å¸¦æ¥çš„ä»£ç ä¼˜åŒ–)
-   å®˜æ–¹ç½‘ç«™ï¼š[hackersdelight.org](http://hackersdelight.org/)
-   è§è¯†ä¸€ä¸‹çœŸæ­£çš„ â€œå¥‡æŠ€æ·«å·§â€


# äºŒã€æ•´æ•°æº¢å‡ºä¸ Undefined Behavior

> [è§†é¢‘é“¾æ¥ğŸ”—]( https://www.bilibili.com/video/BV1qa4y1j7xk/?p=5&share_source=copy_web&vd_source=587965785c97101d90acb761204e6795&t=3422 )

## 2.1 Undefined Behavior (UB)

>_Undefined behavior_Â (UB) is the result of executing computer code whose behavior is not prescribed by the language specification to which the code adheres, for the current state of the program. This happens when the translator of the source code makes certain assumptions, but these assumptions are not satisfied during execution. 
><p align="right">-- Wikipedia</p>

C å¯¹ UB çš„è¡Œä¸ºæ˜¯ä¸åšä»»ä½•çº¦æŸçš„ï¼ŒæŠŠ<font color="#ff0000">ç”µè„‘ç‚¸äº†</font>éƒ½è¡Œ

-   å¸¸è§çš„ UBï¼šéæ³•å†…å­˜è®¿é—® (ç©ºæŒ‡é’ˆè§£å¼•ç”¨ã€æ•°ç»„è¶Šç•Œã€å†™åªè¯»å†…å­˜ç­‰)ã€è¢«é›¶é™¤ã€æœ‰ç¬¦å·æ•´æ•°æº¢å‡ºã€å‡½æ•°æ²¡æœ‰è¿”å›å€¼â€¦â€¦
    -   é€šå¸¸çš„åæœæ¯”è¾ƒè½»å¾®ï¼Œæ¯”å¦‚ wrong answer, crash

## 2.2 ä¸ºä»€ä¹ˆ C/C++ ä¼šæœ‰ UBï¼Ÿ

ä¸ºäº†å°½å¯èƒ½é«˜æ•ˆ (zero-overhead)

-   ä¸åˆæ³•çš„äº‹æƒ…çš„åæœåªå¥½ undefined äº†
-   Java, js, python, ... é€‰æ‹©æ‰€æœ‰æ“ä½œéƒ½è¿›è¡Œåˆæ³•æ€§æ£€æŸ¥

ä¸ºäº†å…¼å®¹å¤šç§ç¡¬ä»¶ä½“ç³»ç»“æ„

-   æœ‰äº›ç¡¬ä»¶Â `/0`Â ä¼šäº§ç”Ÿå¤„ç†å™¨å¼‚å¸¸
-   æœ‰äº›ç¡¬ä»¶å•¥ä¹Ÿä¸å‘ç”Ÿ
-   åªå¥½ undefined äº†

## 2.3 Undefined Behavior: ä¸€ä¸ªå†å²æ€§çš„åŒ…è¢±

åŸ‹ä¸‹äº†ç¾éš¾çš„ç§å­

-   CVE:Â _Common Vulnerabilities and Exposures_ï¼Œå…¬å¼€å‘å¸ƒè½¯ä»¶ä¸­çš„æ¼æ´
    -   buffer/integer overflow å¸¸å¹´å æ® CVE çš„ä¸€å¸­ä¹‹åœ°
    -   é«˜å±æ¼æ´è®©æ²¡æœ‰ä¿®è¡¥çš„æœºå™¨ç«‹é©¬å®•ğŸ”/å˜æˆè‚‰ğŸ”

ä¾‹å­ï¼š[CVE-2018-7445](https://nvd.nist.gov/vuln/detail/CVE-2018-7445)Â (RouterOS), ä»…ä»…æ˜¯å¿˜è®°æ£€æŸ¥ç¼“å†²åŒºå¤§å°â€¦â€¦

```c
while (len) {
  for (i = offset; (i - offset) < len; ++i) {
    dst[i] = src[i+1];
  }
  len = src[i+1]; ...
  offset = i + 1;
}
```

## 2.4 Undefined Behavior: è­¦æƒ•æ•´æ•°æº¢å‡º

<table>
<thead>
<tr>
<th align="center">è¡¨è¾¾å¼</th>
<th align="center">å€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><code>UINT_MAX+1</code></td>
<td align="center">0</td>
</tr>
<tr>
<td align="center"><code>INT_MAX+1; LONG_MAX+1</code></td>
<td align="center"><font color="red">undefined</font></td>
</tr>
<tr>
<td align="center"><code>char c = CHAR_MAX; c++;</code></td>
<td align="center"><font color="blue">varies</font> (???)</td>
</tr>
<tr>
<td align="center"><code>1 &lt;&lt; -1</code></td>
<td align="center"><font color="red">undefined</font></td>
</tr>
<tr>
<td align="center"><code>1 &lt;&lt; 0</code></td>
<td align="center">1</td>
</tr>
<tr>
<td align="center"><code>1 &lt;&lt; 31</code></td>
<td align="center"><font color="red">undefined</font></td>
</tr>
<tr>
<td align="center"><code>1 &lt;&lt; 32</code></td>
<td align="center"><font color="red">undefined</font></td>
</tr>
<tr>
<td align="center"><code>1 / 0</code></td>
<td align="center"><font color="red">undefined</font></td>
</tr>
<tr>
<td align="center"><code>INT_MAX % -1</code></td>
<td align="center"><font color="red">undefined</font></td>
</tr>
</tbody>
</table>

-   W. Dietz, et al. Understanding integer overflow in C/C++. InÂ _Proceedings of ICSE_, 2012.

>[!danger] æ— ç¬¦å·æ•´æ•°çš„è¿ç®—æ²¡æœ‰ Undefined Behavior

## 2. 5 æ•´æ•°æº¢å‡ºå’Œç¼–è¯‘ä¼˜åŒ–

```c
int f() { return 1 << -1; }
```

æ ¹æ®æ‰‹å†Œï¼Œè¿™æ˜¯ä¸ª UBï¼Œäºæ˜¯ clang è¿™æ ·å¤„ç½®â€¦â€¦

```
0000000000000000 <f>:
   0:   c3      retq
```

![CLYflP](https://picture-suyifan.oss-cn-shenzhen.aliyuncs.com/uPic/CLYflP.png)


ç¼–è¯‘å™¨æŠŠè¿™ä¸ªè®¡ç®—ç›´æ¥åˆ é™¤äº†ï¼Œ**ç¼–è¯‘å™¨çš„ç›®çš„æ˜¯ç¼–è¯‘å‡ºæ›´å¿«çš„ä»£ç ï¼Œæ‰€ä»¥å¸¸å¸¸å°† UB çš„ä»£ç åˆ é™¤æ‰**

> W. Xi, et al. Towards optimization-safe systems: Analyzing the impact of undefined behavior. InÂ _Proceedings of SOSP_, 2013.


# ä¸‰ã€æµ®ç‚¹æ•°ï¼šIEEE 754 (Turing Award)

>[è§†é¢‘é“¾æ¥ğŸ”—]( https://www.bilibili.com/video/BV1qa4y1j7xk/?p=5&share_source=copy_web&vd_source=587965785c97101d90acb761204e6795&t=3983 )


## 3.1 å®æ•°çš„è®¡ç®—æœºè¡¨ç¤º

**æµ®ç‚¹æ•°çš„æŒ‘æˆ˜**ï¼šå®æ•°éå¸¸éå¸¸å¤š ($\aleph_0 < \mathfrak c$)

-   åªèƒ½ç”¨ 32/64-bit 01 ä¸²æ¥è¡¨ç¤º<font color="#ff0000">ä¸€å°éƒ¨åˆ†</font>å®æ•°
    -   ç¡®å®šä¸€ç§**æ˜ å°„**æ–¹æ³•ï¼ŒæŠŠä¸€ä¸ª 01 ä¸²æ˜ å°„åˆ°ä¸€ä¸ªå®æ•°
        -   è¿ç®—èµ·æ¥ä¸å¤ªéº»çƒ¦
        -   è®¡ç®—è¯¯å·®ä¸å¤ªå¯æ€•

äºæ˜¯æœ‰äº† IEEE754 (1bit S, 23/52bits Fraction, 8/11bits Exponent)

$$
x=(-1)^S \times(1 . F) \times 2^{E-B}
$$

![[IEEE754 Float.png]]

## 3.2 IEEE754: ä½ å¯èƒ½ä¸çŸ¥é“çš„äº‹å®

ä¸€ä¸ªæœ‰å…³æµ®ç‚¹æ•°å¤§å°/å¯†åº¦çš„å®éªŒ ([float.c](http://jyywiki.cn/pages/ICS/2020/demos/float.c))

>[!note] åœ¨ Ubuntu ä¸‹ç›´æ¥ç¼–è¯‘å¯èƒ½ä¼šå‡ºç° log10 æœªå®šä¹‰
>ä½¿ç”¨å‘½ä»¤ `gcc float.c -o float -lm`

è¶Šå¤§çš„æ•°å­—ï¼Œè·ç¦»ä¸‹ä¸€ä¸ªå®æ•°çš„è·ç¦»å°±è¶Šå¤§

-   å¯èƒ½ä¼šå¸¦æ¥ç›¸å½“çš„ç»å¯¹è¯¯å·®
-   å› æ­¤å¾ˆå¤šæ•°å­¦åº“éƒ½ä¼šé¢‘ç¹åšå½’ä¸€åŒ–

>[!example] ä¾‹å­ï¼šè®¡ç®— $1+\frac{1}{2}+\frac{1}{3}+\ldots+\frac{1}{n}$
>
>```c
>#include <stdio. h>
>
>#define n 10000000
>
>#define SUM(T, st, ed, d) ({ \
>  T s = 0; \
>  for (int i = st; i != ed + d; i += d) \
>    s += (T) 1 / i; \
>  s; \
>})
>
>
>int main() {
>	printf("%.16f", SUM(float, 1 , n, 1));
>	printf("%.16f", SUM(float, n , 1, -1));
>	printf("%.16lf", SUM(double, 1 , n, 1));
>	printf("%.16lf", SUM(double, n , 1, -1));
>}
>
>/* 15.4036827087402344 */
>/* 16.6860313415527344 */
>/* 16.6953113658572718 */
>/* 16.6953113658599648 */
>```


æµ®ç‚¹æ•°ç”±äºæœ‰è¯¯å·®ä»¥åŠåšåŠ æ³•çš„èˆå…¥å­˜åœ¨ï¼š
$$
(a+b)+c \ne a + (b+c)
$$

æ¯”è¾ƒ

-   `a == b`Â éœ€è¦è°¨æ…åˆ¤æ–­ (è¦å‡è®¾è‡ªå¸¦Â $\varepsilon$)

éè§„æ ¼åŒ–æ•° (Exponent == 0)

-   $x=(-1)^S \times(0 . F) \times 2^{-126}$

é›¶
-   `+0.0`,Â `-0.0`Â çš„Â $S$Â bit æ˜¯ä¸ä¸€æ ·çš„ï¼Œä½†Â `+0.0 == -0.0`

Inf/NaN (Not a Number)

-   Inf: æµ®ç‚¹æ•°æº¢å‡ºå¾ˆå¸¸è§ï¼Œä¸åº”è¯¥ä½œä¸º undefined behavior
-   NaN (`0.0/0.0`): èƒ½å¤Ÿæ»¡è¶³Â `x != x`Â è¡¨è¾¾å¼çš„å€¼
```c
int main() {
	double x = 0.0 / 0.0;
	printf("%d\n", x != x);// è‡ªå·±ä¸ç­‰äºè‡ªå·±
}
```

## 3.3 IEEE754ï¼šå¼‚å¸¸å¤æ‚

é™¤äº† $x=(-1)^S \times(1 . F) \times 2^{E-B}$, è¿˜è¦è€ƒè™‘

-   éè§„æ ¼åŒ–æ•°, +0.0/-0.0, Inf, NaN
    -   ä¸€åº¦å¼•èµ·äº†ç¡¬ä»¶å‚å•†çš„ä¼—æ€’ (ç¢°åˆ°éè§„æ ¼æ•°å¹²è„†è½¯ä»¶æ¨¡æ‹Ÿå§)
    -   å¾ˆå¤šâ€œå¯¹æµ®ç‚¹æ•°ç²¾åº¦è¦æ±‚ä¸é«˜â€ç¡¬ä»¶å‚å•†é€‰æ‹©ä¸å…¼å®¹ IEEE 754 (æ¯”å¦‚å„ç§ GPU åˆ¶é€ å•†)
    -   Nvidia ä» Fermi æ‰å¼€å§‹å®Œæ•´æ”¯æŒ IEEE754 (2010)

> [An interview with the old man of floating-point](https://people.eecs.berkeley.edu/~wkahan/ieee754status/754story.html). Reminiscences elicited fromÂ [William Kahan](http://http.cs.berkeley.edu/~wkahan/)Â byÂ [Charles Severance](http://www.dr-chuck.com/).


## 3 .4 ä¾‹å­ï¼šè®¡ç®— $\frac{-b-\sqrt{b^2-4 a c}}{2 a}$

å¦‚æœè€ƒè™‘æ¯”è¾ƒæç«¯çš„æ•°å€¼æ¡ä»¶?
- æ¶ˆå»è¯¯å·®: $-b$ v.s. $\sqrt{b^2-4 a c}$ (catastrophic cancellation)
- è¿˜è®°å¾— $x+1.0==x$ çš„ä¾‹å­å—
- æº¢å‡º: $b^2$

ä¸€ä¸ªæ›´å¥½çš„ä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹æ±‚æ ¹å…¬å¼
- $$\frac{(-b)^2-\left(\sqrt{b^2-4 a c}\right)^2}{(-b)+\sqrt{b^2-4 a c}} / 2 a=\frac{4 a c}{(-b)+\sqrt{b^2-4 a c}} / 2 a(b<0)$$
- $$\left(-b-\sqrt{b^2-4 a c}\right) \cdot \frac{1}{2 a}\left(0 \leq b \leq 10^{127}\right)$$
- $$-\frac{b}{a}+\frac{c}{b}\left(b>10^{127}\right)$$
	- P. Panchekha, et al. Automatically improving accuracy for floating point expressions. In Proc. of PLDI, 2015.

## 3.5 å‡­ä»€ä¹ˆ?
>It looked pretty complicated. On the other hand, we had a rationale for everything. 
>--Â [William Kahan](http://http.cs.berkeley.edu/~wkahan/), 1989 ACM Turing Award Winner for hisÂ _fundamental contributions to numerical analysis_.

<center>æµ®ç‚¹æ•°å¯ä»¥ç›´æ¥å½“æˆæ•´æ•°æ¯”è¾ƒå¤§å°</center>
<center>+0.0 /-0.0 å’Œ Inf ä¿è¯ (1 / x) / x ä¸ä¼šå‘ç”Ÿ sign shift</center>
<center>â€¦â€¦</center>

EEE754 å¤©æ‰çš„è®¾è®¡ä¿è¯äº†æ•°å€¼è®¡ç®—çš„ç¨³å®š

>[!note] å¦‚æœæ²¡æœ‰ -0ï¼Œå¯èƒ½ä¼šå¯¼è‡´è´Ÿæ•°çš„æŸäº›è¿ç®—å˜ä¸ºæ­£æ•°

-   å¦‚æœæƒ³äº†è§£ IEEE754ï¼Œè¯·é˜…è¯» D. Goldberg.Â [[What every computer scientist should know about floating-point arithmetic.pdf]].Â _ACM Computing Surveys_, 23 (1), 1991.

# å››ã€æ•°æ®çš„æœºå™¨çº§è¡¨ç¤ºï¼šç»¼åˆæ¡ˆä¾‹

## 4.1 æ¡ˆä¾‹ï¼šè®¡ç®—Â $1/\sqrt{x}$

åº”ç”¨ï¼šSurface Norm

-   å¹³é¢çš„æ³•å‘é‡
    -   ç”¨äºè®¡ç®—å…‰ç…§/åå°„
    -   ~~ç¬¬ä¸€æ¬¡æ„Ÿè§‰æ•°å­¦æ´¾ä¸Šäº†ç”¨åœº~~
-   è®¡ç®—æ–¹æ³•
    -   å¹‚çº§æ•°å±•å¼€
    -   äºŒåˆ†æ³•
    -   ç‰›é¡¿æ³•â€¦â€¦

å¦‚ä½•ä¸å€ŸåŠ©ç¡¬ä»¶æŒ‡ä»¤ï¼Œå¿«é€Ÿ (è¿‘ä¼¼) è®¡ç®—Â $f(x)$ï¼Ÿ

-   äººçœ¼å¯¹åƒç´ çº§çš„è¯¯å·®å¹¶ä¸æ•æ„Ÿï¼Œå› æ­¤ç®—é”™ä¸€ç‚¹ä¹Ÿæ²¡äº‹
-   å¿« 1.5 å€:Â $640 \times 480 \to 800 \times 600$Â (è¿™ä¸ªæ¨å¯¼ä¸ä¸¥æ ¼ï¼‰

## 4.2 ç¥å¥‡çš„Â $O(1)$Â ä»£ç 

```c
float Q_rsqrt( float number ) {
  union { float f; uint32_t i; } conv;
  float x2 = number * 0.5F;
  conv.f = number;
  conv.i = 0x5f3759df - ( conv.i >> 1 ); // ???
  conv.f = conv.f * ( 1.5F - ( x2 * conv.f * conv.f ) );
  return conv.f;
}
```

çœ‹çœ‹åˆ«äººçš„æ¯•ä¸šè®¾è®¡

-   Matthew Robertson.Â [A Brief History of InvSqrt](http://jyywiki.cn/static/wiki/ics/rsqrt.pdf),Â _Bachelor Thesis, The University of New Brunswick_, 2012.

## 4.3 æ¡ˆä¾‹ï¼šè®¡ç®— $(a \times b) \bmod m$

```c
int64_t multimod_fast(int64_t a, int64_t b, int64_t m) {
  int64_t x = (int64_t)((double)a * b / m) * m;
  int64_t t = (a * b - x) % m;
  return t < 0 ? t + m : t;
}
```

ä»¤ $a \times b=p \cdot m+q$
- $\mathrm{a} * \mathrm{~b} \rightarrow(p \cdot m+q) \bmod 2^{64}$
- $\mathrm{x} \rightarrow\left(\left\lfloor\frac{p \cdot m+q}{m}\right\rfloor \cdot m\right) \bmod 2^{64}$
	- å¦‚æœæµ®ç‚¹æ•°çš„ç²¾åº¦æ˜¯æ— é™çš„, $x=(p \cdot m) \bmod 2^{64}$
	- åŒä½™å°±å¾—åˆ°äº† $q$

# äº”ã€æ€»ç»“

## 5.1 æ•°æ®çš„æœºå™¨çº§è¡¨ç¤º

_Everything_Â is a bit-string!

-   ä½†å´èƒ½ç©å‡ºå¾ˆå¤šèŠ±æ ·æ¥
    -   bit-set/SIMD
    -   æµ®ç‚¹æ•°çš„è¡¨ç¤º


PA: ç¦æ­¢å†™å‡ºä¸å¯ç»´æŠ¤çš„ä»£ç 

-   å¦‚æœä½ æƒ³ç©å‡ºèŠ±ï¼Œè¯·åšåˆé€‚çš„å°è£…å’Œå……åˆ†çš„æµ‹è¯•